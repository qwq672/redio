name: 纯电台半动态播放列表
on:
  workflow_dispatch:

jobs:
  build_playlist:
    runs-on: ubuntu-latest
    steps:
      - name: 读取项目文件
        uses: actions/checkout@v4

      - name: 生成干净电台播放列表.m3u8
        run: |
          python3 << 'EOF'
          import json
          import random

          # 读取你本来就有的节目文件
          with open("programs.json", "r", encoding="utf-8") as f:
              programs = json.load(f)

          # 给每个节目加ID
          for i, p in enumerate(programs):
              p["id"] = i + 1

          # 生成播放序列（核心规则：相邻不重复，隔一个才能重复）
          play_times = 20  # 想播多少个就改这里
          last_id = None
          playlist = ["#EXTM3U"]

          for _ in range(play_times):
              # 只排除上一个，满足：相邻不重复 = 至少隔1个
              available = [p for p in programs if p["id"] != last_id]
              pick = random.choice(available)
              playlist.append(f"#EXTINF:{pick['dur']},电台{pick['id']}")
              playlist.append(pick["m3u8"])
              last_id = pick["id"]

          # 直接输出到 playlist.m3u8（不删你任何文件，只新增这个）
          with open("playlist.m3u8", "w", encoding="utf-8") as f:
              f.write("\n".join(playlist))

          print("✅ 生成完成：playlist.m3u8")
          EOF

      - name: 保存最终播放列表
        uses: actions/upload-artifact@v4
        with:
          name: playlist
          path: playlist.m3u8
